{% extends 'include/base.html' %}

{% block title %}
    예약
{% endblock %}

{% block link %}
    <link rel="stylesheet" href="/static/css/reservation/reservation.css" />
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css' rel='stylesheet' />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css' rel='stylesheet' />
{% endblock %}

{% block main %}
    <main class="container py-4">
        <div class="row">
            <!-- 왼쪽 컬럼: 달력 -->
            <div class="col-md-6 mb-4">
                <div class="reservation-calendar-section p-4 bg-white rounded shadow-sm">
                    <div class="reservation-header d-flex align-items-center mb-3 border-bottom pb-2">
                        <h2 class="mb-0">
                            <i class="fa-solid fa-calendar-alt me-2 text-warning" aria-hidden="true"></i>
                            일정을 선택하세요.
                        </h2>
                    </div>
                    <div class="reservation-calendar" id="calendar" role="grid"></div>
                </div>
            </div>

            <!-- 오른쪽 컬럼: 시간 슬롯 -->
            <div class="col-md-6 mb-4">
                <div class="time-slot-section p-4 bg-white rounded shadow-sm">
                    <div class="time-slot-selection">
                        <h3 class="fs-5">오전</h3>
                        <div class="d-flex flex-wrap gap-2 mb-3" id="morningSlots" role="listbox" aria-label="오전 시간대"></div>
                        <h3 class="fs-5">오후</h3>
                        <div class="d-flex flex-wrap gap-2" id="afternoonSlots" role="listbox" aria-label="오후 시간대"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 하단 섹션: 선택된 정보와 예약 버튼 -->
        <div class="row">
            <div class="col-12">
                <div class="reservation-info-section p-4 bg-white rounded shadow-sm mt-4">
                    <div class="selected-info mb-3">
                        <h4 class="fw-bold">선택한 날짜: <span id="selectedDateDisplay" aria-live="polite">선택되지 않음</span></h4>
                        <h4 class="fw-bold">선택한 시작 시간: <span id="selectedStartTimeDisplay" aria-live="polite">선택되지 않음</span></h4>

                        <!-- 인원 선택 섹션 -->
                        <h4 class="fw-bold">
                            <i class="fa fa-user" aria-hidden="true"></i> 인원을 선택하세요:
                            <div class="d-inline-flex align-items-center">
                                <button id="decreasePeople" class="btn btn-outline-secondary btn-sm" type="button" aria-label="인원 감소">-</button>
                                <span id="selectedPeople" class="mx-2" aria-live="polite">1</span>
                                <button id="increasePeople" class="btn btn-outline-secondary btn-sm" type="button" aria-label="인원 증가">+</button>
                            </div>
                        </h4>
                        <h4 class="fw-bold">가격: <span id="selectedPriceDisplay">{{ rent.price if rent.price else '가격 없음' }}</span></h4>
                    </div>

                    <div class="confirmation-switch d-flex align-items-center mb-3">
                        <label class="switch">
                            <input type="checkbox" id="confirmSelection" aria-checked="false">
                            <span class="slider round"></span>
                        </label>
                        <label for="confirmSelection" class="ms-2">예약을 확인하세요</label>
                    </div>
                    <button class="reservation-button btn btn-primary w-100 mt-4 py-2" id="makeReservation" disabled>예약하기</button>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block script %}
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js'></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var maxPeople = parseInt("{{ rent.people }}", 10);
            var selectedPeople = 1;
            var selectedDate = null;
            var selectedStartTime = null;
            var selectedEndTime = null;
            var pricePerSlot = parseInt("{{ rent.price }}", 10);
            var calendarEl = document.getElementById('calendar');
            var spaceno = "{{ rent.spaceno }}";
            var makeReservationButton = document.getElementById('makeReservation');

            // Initialize Calendar
            if (calendarEl) {
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ko',
                    themeSystem: 'bootstrap',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    validRange: {
                        start: new Date(),
                        end: new Date(new Date().setMonth(new Date().getMonth() + 3))
                    },
                    events: fetchAvailableDates,
                    buttonText: {
                        today: '오늘',
                        month: '월',
                        week: '주',
                        day: '일'
                    },
                    dateClick: function(info) {
                        selectedDate = info.dateStr;
                        updateSelectedInfo();
                    }
                });

                calendar.render();
            }

            {#// Fetch available dates#}
            {#function fetchAvailableDates(fetchInfo, successCallback, failureCallback) {#}
            {#    fetch(`/api/rental/${spaceno}/avail_dates`)#}
            {#        .then(response => response.json())#}
            {#        .then(data => {#}
            {#            if (Array.isArray(data)) {#}
            {#                var events = data.map(date => ({#}
            {#                    title: '예약 가능',#}
            {#                    start: date,#}
            {#                    display: 'background'#}
            {#                }));#}
            {#                successCallback(events);#}
            {#            } else {#}
            {#                console.error('Unexpected data format:', data);#}
            {#                failureCallback('Unexpected data format');#}
            {#            }#}
            {#        })#}
            {#        .catch(error => {#}
            {#            console.error('Error fetching available dates:', error);#}
            {#            failureCallback(error);#}
            {#        });#}

            {#// Generate time slots dynamically#}
            {#function generateTimeSlots() {#}
            {#    var morningSlotsEl = document.getElementById('morningSlots');#}
            {#    var afternoonSlotsEl = document.getElementById('afternoonSlots');#}
            {#    var slots = {#}
            {#        morning: ['09:00', '11:00'],#}
            {#        afternoon: ['13:00', '15:00', '17:00', '19:00', '21:00']#}
            {#    };#}
            {##}
            {#    for (const [period, times] of Object.entries(slots)) {#}
            {#        times.forEach(function(time) {#}
            {#            var button = document.createElement('button');#}
            {#            button.className = 'btn btn-outline-secondary time-slot';#}
            {#            button.textContent = time;#}
            {#            button.addEventListener('click', function() {#}
            {#                toggleTimeSlot(button, time);#}
            {#            });#}
            {##}
            {#            if (period === 'morning') {#}
            {#                morningSlotsEl.appendChild(button);#}
            {#            } else {#}
            {#                afternoonSlotsEl.appendChild(button);#}
            {#            }#}
            {#        });#}
            {#    }#}





    </script>
{% endblock %}
